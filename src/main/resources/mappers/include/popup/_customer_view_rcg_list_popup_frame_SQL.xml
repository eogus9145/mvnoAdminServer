<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="telecentro.include._customer_view_rcg_list_popup_frame">
	<sql id="_customer_view_rcg_list_popup_frame">
	<![CDATA[
		SELECT /*+ INDEX_DESC(A RECHARGE_IDX3) */
			   SERVICE_ACCOUNT,
			   SERVICE_NUMBER NO_MASK_SERVICE_NUMBER,
			   REFUND_SEQ,
			   DATA_CD,
			   RCG_SEQ,
			   TELCO,
			   IN_AMOUNT,
			   TO_CHAR(RCG_DATE, 'YYYY-MM-DD HH24:MI:SS') RCG_DATE,
			   REQ_SRC,
			   CHG_TYPE,
			   ${db.mainschema}.F_GET_COMMON_CD_NM('RCG', 'CHG_TYPE', CHG_TYPE) CHG_TYPE_NM,
			   RES_CD,
			   RES_MSG,
			   RCG_NUMBER,
			   AMOUNT,
			   CANCEL_FLAG,
			   (CASE WHEN CANCEL_FLAG = 'Y' THEN TO_CHAR(CANCEL_DT, 'YYYY-MM-DD') ELSE '' END) CANCEL_DT, 
			   BALANCE,
			   STATUS,
			   ${db.mainschema}.F_GET_COMMON_CD_NM('RCG', 'STATUS', STATUS) STATUS_NM,
			   RCG_INFO,
			   RCG_METHOD,
			   RCG_RSN, 
			   ${db.mainschema}.F_GET_COMMON_CD_NM('RCG', 'RCG_RSN', RCG_RSN) RCG_RSN_NM,
			   RCG_AGENT,
			   ${db.mainschema}.F_GET_AGENT_INFO('AGENT_NAME', RCG_AGENT) RCG_AGENT_NM,
			   TO_CHAR(BASIC_EXPIRE, 'YYYY-MM-DD') BASIC_EXPIRE,
			   TO_CHAR(DATA_EXPIRE, 'YYYY-MM-DD') DATA_EXPIRE,
			   TO_CHAR(TOPUP_E_DT, 'YYYY-MM-DD') TOPUP_E_DT,
			   REQ_TYPE,
			   REMARK
		 FROM ${db.mainschema}.RCG A 
		 WHERE SERVICE_ACCOUNT = #{account}
				AND RCG_DATE > TO_DATE('20150101', 'YYYYMMDD')
			]]>
		
			${@telecentro.common.service.CommonUtil@get_section_query("RCG_DATE", null, s_dt, e_dt, "Y", null)}
			
	</sql>
	<sql id="_customer_view_rcg_list_popup_frame_add">
	<![CDATA[
		, (SELECT RETRY_USABLE FROM ${db.mainschema}.CD_RCG_GUBUN WHERE REQ_GUBUN = fq.REQ_TYPE) RETRY_USABLE
	]]>
	</sql>
	<select id="_customer_view_rcg_list_popup_frame" parameterType="map" resultType="egovMap">
	<![CDATA[
		SELECT
            fq.SERVICE_ACCOUNT,
			fq.NO_MASK_SERVICE_NUMBER,
			fq.REFUND_SEQ,
			fq.DATA_CD,
			fq.RCG_SEQ,
			fq.TELCO,
			fq.IN_AMOUNT,
			fq.RCG_DATE,
			fq.REQ_SRC,
			fq.CHG_TYPE,
			fq.CHG_TYPE_NM,
			fq.RES_CD,
			fq.RES_MSG,
			fq.RCG_NUMBER,
			fq.AMOUNT,
			fq.CANCEL_FLAG,
			fq.CANCEL_DT,
			fq.BALANCE,
			fq.STATUS,
			fq.STATUS_NM,
			fq.RCG_INFO,
			fq.RCG_METHOD,
			fq.RCG_RSN, 
			fq.RCG_RSN_NM,
			fq.RCG_AGENT,
			fq.RCG_AGENT_NM,
			fq.BASIC_EXPIRE,
			fq.DATA_EXPIRE,
			fq.TOPUP_E_DT,
			fq.REMARK
	]]>
		<include refid="_customer_view_rcg_list_popup_frame_add" />
	<![CDATA[
        FROM (
	]]>
		<include refid="_customer_view_rcg_list_popup_frame" />
		ORDER BY A.SERVICE_ACCOUNT DESC, A.RCG_DATE DESC
		LIMIT #{endRowNum} OFFSET #{startRowNum}
	<![CDATA[
    	) fq
	]]>
	</select>

	<select id="_customer_view_rcg_list_popup_frame_excel" parameterType="map"
		resultType="egovMap">
		<![CDATA[
			SELECT
	            fq.*
	            ]]><include refid="_customer_view_rcg_list_popup_frame_add" /><![CDATA[
	        FROM
	            (
	            ]]><include refid="_customer_view_rcg_list_popup_frame" /><![CDATA[
	            ) fq
		]]>
	</select>

	<select id="_customer_view_rcg_list_popup_frame_tot_cnt" parameterType="map"
		resultType="int">
	<![CDATA[
		SELECT
            COUNT(1) CNT
        FROM
            (
            ]]><include refid="_customer_view_rcg_list_popup_frame" /><![CDATA[
            )
	]]>
	</select>
	
</mapper>