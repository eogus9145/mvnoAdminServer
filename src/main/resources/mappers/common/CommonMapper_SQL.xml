<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.telesoft.mvnogen.mapper.common.CommonMapper">
	
	<select id="CommonMapper_admin_auth_menu" parameterType="map" resultType="map">
		WITH RECURSIVE 
		T1 AS (
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL
			FROM ADMIN_AUTH_MENU
			WHERE AUTH_CD IN (SELECT AUTH_CD FROM ADMIN_AUTH WHERE GRADE IN (SELECT GRADE FROM ADMIN WHERE ADMIN_ID = #{SESSION_ADM_ID})AND GRADE IN (SELECT GRADE FROM ADMIN_GRADE))
				AND AUTH_TYPE = 'MENU'
			
			UNION ALL
			
			SELECT 
			A.AUTH_CD, A.AUTH_NAME, A.AUTH_DEPTH, A.AUTH_SORT, A.AUTH_PARENT, A.AUTH_URL
			FROM ADMIN_AUTH_MENU A
			INNER JOIN T1 AA ON AA.AUTH_PARENT = A.AUTH_CD
			WHERE A.AUTH_TYPE = 'MENU'
		),
		T2 AS (
			
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL
			FROM ADMIN_AUTH_MENU
			WHERE AUTH_TYPE = 'SKIP'
		
			UNION ALL
		
			SELECT A.AUTH_CD, A.AUTH_NAME, A.AUTH_DEPTH, A.AUTH_SORT, A.AUTH_PARENT, A.AUTH_URL
			FROM ADMIN_AUTH_MENU A
			INNER JOIN T2 AA ON AA.AUTH_PARENT = A.AUTH_CD
		), 
		UNION_QUERY AS (
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL FROM T1 
			UNION ALL 
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL FROM T2
		)
		SELECT 
			AUTH_CD, 
			AUTH_NAME, 
			AUTH_DEPTH, 
			AUTH_SORT, 
			AUTH_PARENT, 
			REPLACE(AUTH_URL, '|', '') AUTH_URL,
			(SELECT AUTH_NAME FROM ADMIN_AUTH_MENU WHERE AUTH_CD = A.AUTH_PARENT) PARENT_STR
		FROM UNION_QUERY A
		GROUP BY AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL
		ORDER BY AUTH_DEPTH, AUTH_SORT
	</select>
	
	<select id="CommonMapper_get_first_menu" parameterType="map" resultType="map">
		WITH RECURSIVE T1 AS (
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL
			FROM SIWMVNO.ADMIN_AUTH_MENU
			WHERE AUTH_CD IN (
				SELECT AUTH_CD
				FROM SIWMVNO.ADMIN_AUTH
				WHERE GRADE IN (
					SELECT GRADE FROM SIWMVNO.ADMIN WHERE ADMIN_ID = #{adminId}
				)
				AND GRADE IN (SELECT GRADE FROM SIWMVNO.ADMIN_GRADE)
			)
			AND AUTH_TYPE = 'MENU'
    
			UNION ALL
    
			SELECT A.AUTH_CD, A.AUTH_NAME, A.AUTH_DEPTH, A.AUTH_SORT, A.AUTH_PARENT, A.AUTH_URL
			FROM SIWMVNO.ADMIN_AUTH_MENU A
			INNER JOIN T1 AA ON AA.AUTH_PARENT = A.AUTH_CD
			WHERE A.AUTH_TYPE = 'MENU'
		),
		T2 AS (
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL
			FROM SIWMVNO.ADMIN_AUTH_MENU
			WHERE AUTH_TYPE = 'SKIP'
    
			UNION ALL
    
			SELECT A.AUTH_CD, A.AUTH_NAME, A.AUTH_DEPTH, A.AUTH_SORT, A.AUTH_PARENT, A.AUTH_URL
			FROM SIWMVNO.ADMIN_AUTH_MENU A
			INNER JOIN T2 AA ON AA.AUTH_PARENT = A.AUTH_CD
		),
		UNION_QUERY AS (
			SELECT * FROM T1
			UNION ALL
			SELECT * FROM T2
		)
		SELECT REPLACE(AUTH_URL, '|', '') AS AUTH_URL
		FROM UNION_QUERY
		WHERE AUTH_URL IS NOT NULL AND AUTH_URL != ''
		ORDER BY AUTH_DEPTH, AUTH_SORT, AUTH_CD::INTEGER
		LIMIT 1
	</select>
	
	<select id="CommonMapper_get_search_menu_list" parameterType="map" resultType="map">
		WITH RECURSIVE 
		T1 AS (
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL
			FROM ADMIN_AUTH_MENU
			WHERE AUTH_CD IN (SELECT AUTH_CD FROM ADMIN_AUTH WHERE GRADE IN (SELECT GRADE FROM ADMIN WHERE ADMIN_ID = #{adminId})AND GRADE IN (SELECT GRADE FROM ADMIN_GRADE))
				AND AUTH_TYPE = 'MENU'
			
			UNION ALL
			
			SELECT 
			A.AUTH_CD, A.AUTH_NAME, A.AUTH_DEPTH, A.AUTH_SORT, A.AUTH_PARENT, A.AUTH_URL
			FROM ADMIN_AUTH_MENU A
			INNER JOIN T1 AA ON AA.AUTH_PARENT = A.AUTH_CD
			WHERE A.AUTH_TYPE = 'MENU'
		),
		T2 AS (
			
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL
			FROM ADMIN_AUTH_MENU
			WHERE AUTH_TYPE = 'SKIP'
		
			UNION ALL
		
			SELECT A.AUTH_CD, A.AUTH_NAME, A.AUTH_DEPTH, A.AUTH_SORT, A.AUTH_PARENT, A.AUTH_URL
			FROM ADMIN_AUTH_MENU A
			INNER JOIN T2 AA ON AA.AUTH_PARENT = A.AUTH_CD
		), 
		UNION_QUERY AS (
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL FROM T1 
			UNION ALL 
			SELECT AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL FROM T2
		)
		SELECT 
			VALUE, LABEL, AUTH_URL
		FROM (
			SELECT 
				AUTH_CD VALUE,
				(SELECT AUTH_NAME FROM ADMIN_AUTH_MENU WHERE AUTH_CD = A.AUTH_PARENT LIMIT 1) || ' > ' || AUTH_NAME LABEL,
				(SELECT AUTH_SORT FROM ADMIN_AUTH_MENU WHERE AUTH_CD = A.AUTH_PARENT LIMIT 1) || '' || AUTH_SORT SORT,
				AUTH_URL
			FROM UNION_QUERY A
			WHERE AUTH_URL IS NOT NULL AND AUTH_URL != ''
			GROUP BY AUTH_CD, AUTH_NAME, AUTH_DEPTH, AUTH_SORT, AUTH_PARENT, AUTH_URL
			ORDER BY SORT
		) AA
		WHERE LABEL ILIKE '%' || #{keyword} || '%' 
	</select>
	
	<insert id="CommonMapper_monMsg" parameterType="map">
		
	</insert>
	
	<select id="select_masking" parameterType="map" resultType="java.lang.String">
		SELECT '|' || COALESCE(ARRAY_TO_STRING(ARRAY_AGG(AUTH_CD), '|'), '') || '|'
		FROM(
			SELECT AUTH_CD 
			FROM ADMIN_AUTH_MENU_SUB
			WHERE AUTH_CD IN (SELECT AUTH_CD FROM ADMIN_AUTH_MASKING WHERE GRADE IN (SELECT GRADE FROM ADMIN WHERE ADMIN_ID = #{login_id}))
			      AND MASKING_FLAG = 'Y'
		) A
	</select>
	
</mapper>